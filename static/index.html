<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8"/>
    <title>Tor Browser Manual Screenshot Creator</title>
    <link rel="stylesheet" href="thirdparty/croppr.min.css">
    <script src="thirdparty/croppr.min.js"></script>
    <style>
     #first-screenshot {
       max-width: 100%;
     }
    </style>
  </head>
  <body>
    <script>
     let croppr1 = null;
     let handleMessage = e => {
       let { state, filename } = JSON.parse(e.data);
       switch (state) {
         case "recorded":
           let img1 = document.getElementById("first-screenshot");
           img1.src = filename;
           croppr1 = new Croppr(img1, { startSize: [90, 90, '%'] });
           break;
       }
     };

     let socket;
     (async () => {
       socket = new WebSocket("ws://localhost:3000/websocket");
       await new Promise(resolve => { socket.onopen = resolve; });
       socket.onmessage = handleMessage;
       socket.send(JSON.stringify({"cmd":"ready"}));
     })();

     let getImageName = () => document.getElementById("screenshot-name").value;

     let send = obj => socket.send(JSON.stringify(obj));
     let startRecording = () => {
       let imageName = getImageName();
       if (imageName.length === 0) {
         alert("Please choose a screenshot name");
       } else {
         send({"cmd":"record", imageName });
       }
     };
     let manualCropDone = async () => {
       let results = croppr1.getValue();
       results.imageName = getImageName();
       document.cookie = JSON.stringify(results);
       send(Object.assign({"cmd":"crop"}, results));
       location.href = "/acquire.html";
     };
    </script>
    <h1>Tor Browser Manual Screenshot Creator Setup</h1>
    <h2>Paths</h2>
    <p>Enter Tor Browser path: <input id="tbb-path"></input></p>
    <p>Enter Tor Browser Manual path: <input id="tbb-path"></input></p>
    <h2>Capture first screenshot (en-US)</h2>
    <p>Enter screenshot name: <input id="screenshot-name"></input></p>
    <p>
      <button id="record" onclick="startRecording()">
        Start recording
      </button>
      (Ctrl-Space to Stop and Take Screenshot)</p>
    <h2>Crop screenshot (en-US)</h2>
    <p>
      Please drag the box to crop the image below. Click when you are done:
      <button id="done-cropping" onclick="manualCropDone()">
        Done
      </button>
      <img id="first-screenshot" src="" width="30%"></img>
    </p>
  </body>
</html>
